#!/usr/bin/env ruby

require 'json'

value   = `bdmesg`.lines.find { |l| l =~ /SelfDevicePath=(.*)\r/ and break $1 }
uuid    = value.split('\\').last[/(?:<?GPT,)([\h-]+)/, 1] or exit 1
dev     = `partutil --search-uuid #{uuid}`.chomp
volname = `partutil --show-volumename #{dev}`.chomp
disk    = `partutil --show-wholedisk #{dev}`.chomp
sdisk   = `diskutil list #{disk}`.lines.grep(/Apple_APFS/).first.split(/\s+/)[4]
vols    = `diskutil list #{sdisk}`.lines.grep(/^\s*[1-9]\d*:/).join.scan(/(?:<?Volume\s+)(\S+)/).flatten
jj({ dev: dev, volname: volname, uuid: uuid, disk: disk, sdisk: sdisk, vols: vols })
