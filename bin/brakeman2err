#!/usr/bin/env ruby

require 'json'
require 'tins/xt'
require 'tins/go'
include Tins::GO

opt = go 'c'
if opt['c']
  brakeman = `bundle exec which brakeman`.full? or fail "cannot find brakeman in path"
  system *%w'bundle exec brakeman -q -s brakeman_ignore --url-safe-methods brakeman_ignore -o .brakeman.json' or fail "calling brakeman failed"
end
results = JSON File.read('.brakeman.json'), object_class: JSON::GenericObject
puts "Found #{results.errors.size} errors and #{results.warnings.size} warnings.",
  "_" * 80
for error in results.errors
  puts error.location, "Error #{error.error.inspect}"
end
for warning in results.warnings
  puts "#{warning.file}:#{warning.line}",
    "#{warning.warning_type} (#{warning.confidence}) #{warning.message.inspect}",
    warning.code, "See: #{warning.link}"
end
