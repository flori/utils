#!/usr/bin/env ruby

require 'fileutils'
include FileUtils::Verbose

msg = "Usage: #$0 EXECUTABLE DIR [LIB ..]"
executable = ARGV.shift or fail msg
dir = ARGV.shift or fail msg
dir = File.expand_path dir
mkdir_p dir

unless executable.start_with? '/'
  executable = `which #{executable}`.chomp
end
libs = `ldd #{executable}`.gsub(/^(?:.*?\s+=>\s+|\s+)(.*?)\(.*/, '\1').lines.grep(/\S/).map { |x| x.strip }
libs.concat ARGV
cd dir do
  cp executable, File.basename(executable)
  for l in libs
    begin
      cp l, File.basename(l)
    rescue Errno::ENOENT => e
      warn "Caught #{e.class}: #{e}"
    end
  end
end
