#!/usr/bin/env ruby

require 'spruz/go'
include Spruz::GO
require 'utils/edit'
include Utils::Edit
require 'tempfile'

$opt = go 'wp'

editor = Editor.new do |config|
  config.wait           = $opt['w']
  config.pause_duration = ($opt['p'] || 1).to_i
end

argv = ARGV.dup
if argv.empty?
  if !STDIN.tty?
    file = File.new(File.join(Dir.tmpdir, "edit_tmp.#$$"), 'w')
    until STDIN.eof?
      buffer = STDIN.read(8192)
      file.write buffer
    end
    file.close
    argv << file.path
  else
    editor.ensure_running
  end
end
unless argv.empty?
  if editor.file_linenumber?(argv.first)
    editor.wait = argv.size > 1
    for current_file in argv
      STDOUT.puts "Edit #{current_file}"
      editor.edit current_file
    end
  else
    editor.edit(*argv)
  end
end
exit 0
