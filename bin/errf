#!/usr/bin/env ruby

require 'term/ansicolor'

class String
  include Term::ANSIColor
end

file = ARGV.shift
name = ARGV.shift
ENV['RUBYOPT'] = "#{ENV['RUBYOPT']} -Iext:lib:test:tests"

STDOUT.sync = true
begin
  output =
    if name
      IO.popen("testrb -p '' -n #{name} #{file}", 'r')
    else
      IO.popen("testrb -p '' #{file}", 'r')
    end
  until output.eof?
    line = output.readline.uncolored
    new_line = line.chomp
    if new_line.sub!(%r(^(?:\s|[\/\[])*([^:]+):(\d+):(.*))) { "#$1:#$2:#$3" }
      puts new_line
    else
      puts line
    end
  end
ensure
  output and output.close
end
