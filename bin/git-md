#!/usr/bin/env ruby

require 'utils/markdown'
include Utils::Markdown
require 'shellwords'

cmd = %{git log --color=always --pretty=format:"commit %C(auto)%H%d%nDate:   %Cgreen%cD (%cr)%Creset%nAuthor: %Cblue%an <%ae>%Creset%n%nMARKUP%n%s%n%n%b%nMARKDOWN%n"}

IO.popen("#{cmd} #{Shellwords.join(ARGV)}") do |log|
  until log.eof?
    message = nil
    log.each do |line|
      case line
      when /^MARKUP$/
        message =  ''
      when /^MARKDOWN$/
        puts markdown(message + "\n---\n")
        message = nil
      else
        if message
          message << line
        else
          puts line
        end
      end
    end
  end
end
