#!/usr/bin/env ruby

require 'utils/irb'
include Utils::IRB

def usage
  <<~EOT
    Usage: #{File.basename($0)} ACTION

    Actions:
      store_snippet            Store code snippet from STDIN as current snippet
      retrieve_current_snippet Show the currently stored snippet
      eval_current_snippet     Evaluate the currently stored snippet
      execute_current_snippet  Execute the currently stored snippet (no output)
      execute_snippet          Execute code snippet from STDIN (no output)
      eval_snippet             Evaluate code snippet from STDIN and print result
      eval_lines               Evaluate code lines from STDIND and print comment results
      stop_server              Stop the IRB server

    Examples:
      # Evaluate code and get result
      echo '2 + 2' | #{File.basename($0)} eval_snippet
      # => 4

      # Execute code (no output)
      echo 'puts "hello"' | #{File.basename($0)} execute_snippet

      # Store code snippet
      echo 'def hello; "world"; end' | #{File.basename($0)} store_snippet

      # Work with stored snippets
      echo 'def hello; "world"; end' | #{File.basename($0)} store_snippet
      #{File.basename($0)} retrieve_current_snippet
      # => def hello; "world"; end
      #{File.basename($0)} eval_current_snippet
      # => "world"

      # Stop server
      #{File.basename($0)} stop_server
  EOT
end
    
case action = ARGV.shift || 'usage'
when 'store_snippet'
  irb_client.send(action, STDIN.read)
when 'retrieve_current_snippet'
  puts irb_client.send('eval_snippet', '@snippet')
when 'eval_current_snippet'
  puts irb_client.send('eval_snippet', 'eval(@snippet)')
when 'execute_current_snippet'
  puts irb_client.send('execute_snippet', 'eval(@snippet)')
when 'execute_snippet'
  irb_client.send(action, STDIN.read)
when 'eval_snippet'
  puts irb_client.send(action, STDIN.read)
when 'eval_lines'
  prefix = ARGV.shift || ' # => '
  lines  = STDIN.readlines
  if lines.empty?
    abort "No input provided"
  else
    puts irb_client.send('eval_lines', lines, prefix)
  end
when 'stop_server'
  irb_client.send(action)
else
  abort usage
end
