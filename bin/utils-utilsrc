#!/usr/bin/env ruby

require 'tempfile'
require 'utils'

# Creates a default utilsrc file by generating configuration content and
# yielding temporary and source paths.
#
# This method checks if a utilsrc file exists at the configured path, and if so,
# creates a temporary file containing the Ruby representation of the current
# configuration. It then yields both the temporary file path and the original
# utilsrc path to the provided block for further processing.
#
# @return [ nil ] returns nil if no utilsrc file exists at the configured path
#
# @yield [ tmp_path, source_path ]
#
# @yieldparam tmp_path [ String ] the path to the temporary file containing configuration
# @yieldparam source_path [ String ] the path to the original utilsrc file
def create_default_utilsrc
  if File.exist?($utilsrc)
    Tempfile.open('utilsrc') do |tmp|
      tmp.puts $config.to_ruby
      tmp.flush
      yield tmp.path, $utilsrc
    end
  end
end

$config = Utils::ConfigFile.new
utilsrc_path = if ARGV.size == 2
                 ARGV.pop
               else
                 '~/.utilsrc'
               end
$utilsrc = File.expand_path(utilsrc_path)

case cmd = ARGV.shift
when 'show'
  if File.exist?($utilsrc)
    puts File.read($utilsrc)
  else
    puts $config.to_ruby
  end
when 'default'
  puts $config.to_ruby
when 'diff'
  create_default_utilsrc do |default_utilsrc, utilsrc|
    system "diff --color=always -u #{default_utilsrc.inspect} #{utilsrc.inspect}"
  end
when 'edit'
  create_default_utilsrc do |default_utilsrc, utilsrc|
    system "vimdiff #{default_utilsrc.inspect} #{utilsrc.inspect}"
  end
else
  puts <<~EOT
    Usage: #{File.basename($0)} show|diff|edit|default [UTILSRC]

    Commands:

    show     - Display current ~/.utilsrc file or default config if none exists
    default  - Show the default Ruby configuration representation
    diff     - Show differences between current config and default using 'diff'
    edit     - Open current config in vimdiff to compare with default for editing


    Arguments:

    UTILSRC   - Optional path to configuration file (defaults to ~/.utilsrc)

  EOT
end
